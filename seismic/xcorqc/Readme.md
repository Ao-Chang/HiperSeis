# Cross-Correlation Workflow

The cross-correlation functionality now works with ASDF files -- for voluminous temporary stations data, a SeisDS object (based on a JSON database) can be utilized to speed up data access. An example, 7G_example.py, shows how data from temporary stations and reference stations can be cross-correlated over a 6 month period, stacked over 10 day intervals. Cross-correlation results are written out as NetCDF-4 files for each station-pair.

Interrogating cross-correlation results requires interactive visualization capabilities. [Panoply], a freely available cross-platform tool, which is also available on NCI VDIs, can be used to visualize the results interactively. A quick intro to [Panoply] is available [here].

## Fetching Permanent Stations Data

File `client_data.py` can be used to fetch permanent stations data, for a given time-range, at given location (lat, lon). Permanent station locations for AU can be found on the [FDSN website].

## Setting up NCI Raijin environment for running cross-correlation

These instructions are for users of the National Computational Infrastructure (NCI) facility at the
Australian National University. The following is the recommended Python environment setup process
within an individual user's account that has been validated and is a known working configuration.
Experience indicates this setup process is fragile and deviation from it will likely lead to a
software environment unable to run `correlator.py`.

### Initial conditions

Upon login to raijin, you should either have the default system Python version (2.6) or specifically
the system install of Python 2.7.13 without a virtual environment. To check, type `which python`.
You should get either:
* `/usr/bin/python` (OS distro version), OR
* `/apps/python/2.7.13/bin/python`

If it is not one of these, examine your `$PATH` environment variable and/or unload modules which are
pulling in a different Python version. Other versions of Python 2.7 available on Raijin are known
to *NOT* work.

With `pip` you should also use the system version, not a user installed upgrade. To check, type
`which pip`, and you should get `/apps/python/2.7.13/bin/pip`.

### Order of operations

To set up the Python environment, the following high level order of operations must be observed:
1. Load modules
1. Build and install customized 3rd party Python libraries for MPI
1. Install standard 3rd party Python libraries

### Library version summary

* Open MPI v2.1.1
* HDF5 v1.10.2 (parallel build)
* MPI for Python v3.0.0
* osbpy 1.1.0
* click 7.0
* netCDF4 1.4.3
* h5py 2.7.0 (custom MPI build)
* pyasdf 0.4.0

### Limitations

In general virtual environments are preferred, but not well supported in Python 2.7, so this
setup uses the python user space (`--user` option of `pip`), but not virtual environments for the
sake of simplicity. This is may not be the only solution, but it is currently the only known working solution.

On Raijin, we need to use Python 2.7.13 since earlier versions don't work properly with MPI. 
Also, the numpy and scipy libraries are custom built for maximum performance on the host hardware.
Due to the multiplicity of Python and library versions that are possible, for maintainability only limited
combinations are supported, typically only one version of numpy and scipy per Python version.

In future new configurations will be developed to support Python >= 3.5.

### Setup process

  1. `module purge` is highly recommended if you have modules loaded, only known to be not 
     necessary for modules `git` and `pbs`
  1. Make git available: `module load git`
  1. Since purging makes `qsub` command unavailable, if you need it enter `module load pbs`)
  1. `module load python/2.7.13` if not the current version
  1. This procedure is known to *NOT* work if you have upgraded `pip`, so ensure you use the 
     system version of pip. To check, type `which pip` and it should be `/apps/python/2.7.13/bin/pip`.
     `pip --version` should give you `pip 9.0.1 from /apps/python/2.7.13/lib/python2.7/site-packages (python 2.7)`
  1. Load Open MPI library version 2.1.1: `module load openmpi/2.1.1`
  1. Verify `which mpicc` returns `/apps/openmpi/2.1.1/bin/mpicc`
  1. Load HDF5 library version 1.10.2 built for parallel execution: `module load hdf5/1.10.2p`
  1. Load MPI for Python library 3.0.0: `module load mpi4py/3.0.0-py2`
  1. Pull h5py repository from github fork of h5py for purpose of custom build: `git clone https://github.com/basaks/h5py.git`
     (this just makes h5py not reject the HDF5 library version on NCI which has appended character 'p' for parallel)
  1. `cd h5py`
  1. `CC=mpicc python setup.py configure --mpi --hdf5=/apps/hdf5/1.10.2p`
  1. Check output generated by previous command, especially that you see `Path to HDF5: '/apps/hdf5/1.10.2p'` and `MPI Enabled: True`
  1. `CC=mpicc python setup.py install --prefix=~/.local`
  1. After lots of build output, you should see somewhere in the last 20 lines of output something very similar to the
     following, indicating installation of the built library into user space for Python packages:
     `Installed /home/547/your_login_id/.local/lib/python2.7/site-packages/h5py-2.7.0.post0-py2.7-linux-x86_64.egg`
  1. `pip install --user obspy==1.1.0`
  1. `pip install --user click`
  1. `pip install --user netCDF4`
  1. `pip install --user pyasdf`

Date last validated: 6 March 2019

#### Setup validation

TODO: how to test the setup


### Version dump of known good configuration

Known good `pip freeze` output:
```
atomicwrites==1.3.0
attrs==19.1.0
backports.shutil-get-terminal-size==1.0.0
certifi==2018.11.29
cftime==1.0.3.4
chardet==3.0.4
Click==7.0
colorama==0.4.1
configparser==3.7.3
cycler==0.10.0
Cython==0.26
decorator==4.1.2
dill==0.2.9
entrypoints==0.3
enum34==1.1.6
flake8==3.7.7
funcsigs==1.0.2
functools32==3.2.3.post2
future==0.17.1
h5py==2.7.0.post0
idna==2.8
ipython==5.4.1
ipython-genutils==0.2.0
isodate==0.6.0
lxml==4.3.2
matplotlib==2.0.2
mccabe==0.6.1
more-itertools==5.0.0
mpi4py==3.0.0
netCDF4==1.4.3
networkx==2.2
nose==1.3.7
numpy==1.14.2
obspy==1.1.0
pathlib2==2.3.0
pexpect==4.2.1
pickleshare==0.7.4
pluggy==0.9.0
prompt-toolkit==1.0.15
prov==1.5.3
ptyprocess==0.5.2
py==1.8.0
pyasdf==0.4.0
pycodestyle==2.5.0
pyflakes==2.1.1
Pygments==2.2.0
pyparsing==2.2.0
pytest==4.3.0
python-dateutil==2.6.1
pytz==2017.2
rdflib==4.2.2
requests==2.21.0
scandir==1.5
scipy==0.19.1
simplegeneric==0.8.1
six==1.10.0
SQLAlchemy==1.3.0
subprocess32==3.2.7
traitlets==4.3.2
typing==3.6.6
urllib3==1.24.1
wcwidth==0.1.7
```


[Panoply]:https://www.giss.nasa.gov/tools/panoply/
[here]:http://www.meteor.iastate.edu/classes/mt452/EdGCM/Documentation/EdGCM_Panoply.pdf
[FDSN website]:http://www.fdsn.org/networks/detail/AU/

